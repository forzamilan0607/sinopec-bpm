<html ng-app="app">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link href="../../build/common/base.css" rel="stylesheet">
    <script type="text/javascript" src="../../build/common/base.js"></script>
    <script type="text/javascript" src="../../build/common/ngEdit.js"></script>
    <script type="text/javascript">
        $(function(){
            window.onload=function(){
                document.querySelector("#file").addEventListener("change",function () {
                    //获取到选中的文件
                    var file = document.querySelector("#file").files[0];
                    document.getElementById('upload').value =file.name;
                })
            }
        });
        var app = angular.module('app', ['baseDirective']);
        app.controller("ctrl", [ '$http','$scope', 'baseService','ArrayToolService', function($http,$scope, baseService,ArrayToolService) {
            $scope.fileUpload =function fileUpload() {
                var file = document.querySelector('input[type=file]').files[0];
                if(file == null) {
                    $.Dialog.error("请选择文件！");
                    return;
                }
                // 构造参数
                formData = new FormData();
                formData.append('file', file, file.name);
                var url = getCtxUrl('/bpm/material/process/import',true);
                var rtn = $http({
                    method:'post',
                    url:url,
                    data:formData,//向后台发送的数据
                    headers:{'Content-type':undefined},
                    transformRequest: angular.identity
                }).success(function(data,header,config,status){
                    msg = data.data
                    if(!data.isSuccess){
                        $.Dialog.success(JSON.stringify(msg.validateList));
                    }else {
                        $.Dialog.success(msg.msg);
                        $.Dialog.close(window);
                    }
                })
                .error(function(data,status){
                    if(status==302){
                        // 直接下载，用户体验好
                        var $form = $('<form method="GET"></form>');
                        $form.attr('action', data.msg);
                        $form.appendTo($('body'));
                        $form.submit();
                        $.Dialog.error('导入失败');
                    }else {
                        console.log("error:",data)
                        $.Dialog.error('导入失败');
                    }
                });
            }
        }])
    </script>
     <style type="text/css">
    .filename{
        width: 270px;
        height: 36px;
        line-height: 36px;
    }
    .ui-upload {
        height: 36px;
        width: 80px;
        background-color: #00abff;
        font-size: 14px;
        line-height: 30px;
        cursor: pointer;
        display: inline-block;
        text-align: center;
        color: #fff;
        border-radius: 3px;
        border: 0px;
        margin-left: 20px;
    }
    .btn{
        margin-top: 40px;
        margin-left: 108px;
        background-color: #BF1C17;
    }
</style>
</head>
<body ng-controller="ctrl" class="panel success">
<div style="margin:0 auto;
text-align:center;
">
    <div>
        <input type="file" file-model="myFile" accept=".xls,.xlsx" id="file" style="display:none;"/>
        <input  class="filename" type="text" id="upload" readonly="readonly" style="vertical-align: middle;"/>
        <button class="ui-upload" onclick="document.getElementById('file').click()">选择文件</button>
    </div>
    <div>
        <button class="ui-upload btn" ng-click="fileUpload()" >导入</button>
        <a class="btn btn-success btn-lg" href="../template/material-purchasing.xlsx"  title="下载模板" mce_href="#">下载模板</a>
    </div>
</div>
</body>
</html>